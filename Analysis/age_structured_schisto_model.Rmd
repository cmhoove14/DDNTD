---
title: "Age structured schistosomiasis model"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#devtools::load_all("../../DDNTD")

require(tidyverse)
```

# Age structured model  
## Fitting procedure  
```{r test_funs}
C_est <- convert_burden_egg_to_worm(60, 0.1, 126,0.71, age_strat_pars["m"], age_strat_pars["zeta"])
A_est <- convert_burden_egg_to_worm(10, 0.1, 19,0.33, age_strat_pars["m"], age_strat_pars["zeta"])

eq_Ws_get_Omega_Lambda0(W_A = A_est[1],
                        kap_A = A_est[2],
                        H_A = 508,
                        W_C = C_est[1],
                        kap_C = C_est[2],
                        H_C = 602,
                        I_P = 0.1,
                        age_strat_pars)

infection_inputs_get_pars(W_A = A_est[1],
                          kap_A = A_est[2],
                          H_A = 508,
                          W_C = C_est[1],
                          kap_C = C_est[2],
                          H_C = 602,
                          I_P = 0.1,
                          age_strat_pars)
```

```{r mod_setup}
#add transmission and other parameters to parameter set
age_strat_use_pars <- infection_inputs_get_pars(W_A = A_est[1],
                                                kap_A = A_est[2],
                                                H_A = 508,
                                                W_C = C_est[1],
                                                kap_C = C_est[2],
                                                H_C = 602,
                                                I_P = 0.1,
                                                age_strat_pars)


# UPDATE BELOW








H_tot <- sum(c(age_strat_use_pars["H_TC"], 
               age_strat_use_pars["H_UC"],
               age_strat_use_pars["H_TA"],
               age_strat_use_pars["H_UA"]))
#Get euilibrium values of state variables
  eq_vals <- runsteady(y = c(S=age_strat_use_pars["K"], E=0, I=0, W_TC=10, W_UC=10, W_TA=10, W_UA=10),
                       func = schisto_age_strat_mod,
                       parms = age_strat_use_pars,
                       stol = 1e-4)$y #lower tolerance to define equilibirum to speed up computation
    names(eq_vals)[1] <- "S"
  
#time frame of simulation  
  years <- 20
  age_time <- c(1:(365*years))

#create MDA events data frame  
  eff <- 0.93
  sac_mda <- data.frame(var = rep('W_TC', years/2),
                        time = c(1:(years/2))*365,
                        value = rep((1 - eff), years/2),
                        method = rep('mult', years/2))
```

## Simulate 10 years of annual MDA in 75% of SAC populaition  
```{r sim_mda_sac}
schisto_mda_sim <- sim_schisto_mod(nstart = eq_vals, 
                                   time = age_time, 
                                   model = schisto_age_strat_mod,
                                   pars = age_strat_use_pars,
                                   events_df = sac_mda) %>% 
  mutate(mean_W = (W_TC*age_strat_use_pars["H_TC"]/H_tot +
                        W_UC*age_strat_use_pars["H_UC"]/H_tot +
                        W_TA*age_strat_use_pars["H_TA"]/H_tot + 
                        W_UA*age_strat_use_pars["H_UA"]/H_tot),
         I_prev = I/(S+E+I),
         Reff = mapply(Reff_Wij, W_TC, W_UC, W_TA, W_UA, MoreArgs = list(pars = age_strat_use_pars))[2,])

schisto_mda_sim %>% 
  gather("Treatment", "Worm Burden",  W_TC:mean_W) %>% 
  ggplot(aes(x = time, y = `Worm Burden`, lty = Treatment)) +
    geom_line() +
    theme_classic() +
    theme(legend.position = c(0.9,0.5)) +
    #ylim(c(0,100)) +
    scale_x_continuous(breaks = c(0:years)*365,
                       labels = c(-1:(years-1)))
```

```{r Reff_plot}
schisto_mda_sim %>% 
  ggplot(aes(x = mean_W, y = Reff)) +
    geom_line() +
    theme_classic()
```

So that makes it look like we're not even close to reaching the breakpoint and maybe haven't even reached $R_{peak}$. Let's increase coverage in SAC and add MDA in adult population and see what plot lokos like

```{r}
#SAME SETUP ROUTINE 
#add transmission and other parameters to parameter set
age_strat_use_pars2 <- augment_age_strat_parameters(I = 0.1, 
                                                   W_A = 19, 
                                                   prev_A = 0.33, 
                                                   H_A = 508, 
                                                   cvrg_A = 0.8,
                                                   W_C = 126, 
                                                   prev_C = 0.71, 
                                                   H_C = 602,
                                                   cvrg_C = 1,
                                                   pars = age_strat_pars)

H_tot2 <- sum(c(age_strat_use_pars2["H_TC"], 
               age_strat_use_pars2["H_UC"],
               age_strat_use_pars2["H_TA"],
               age_strat_use_pars2["H_UA"]))

#Get equilibrium values of state variables
  eq_vals2 <- runsteady(y = c(S=age_strat_use_pars2["K"], E=0, I=0, W_TC=10, W_UC=10, W_TA=10, W_UA=10),
                       func = schisto_age_strat_mod,
                       parms = age_strat_use_pars2,
                       stol = 1e-4)$y #lower tolerance to define equilibirum to speed up computation
    names(eq_vals2)[1] <- "S"
  
#time frame of simulation  
  years <- 40
  age_time <- c(1:(365*years))
    
    
#create MDA events data frame  
  eff <- 0.93
  com_mda <- data.frame(var = rep(c('W_TC', "W_TA"), years/2),
                        time = rep(c(1:(years/2))*365, each = 2),
                        value = rep((1 - eff), years),
                        method = rep('mult', years))

#MODEL RUN  
schisto_mda_sim2 <- sim_schisto_mod(nstart = eq_vals2, 
                                   time = age_time, 
                                   model = schisto_age_strat_mod,
                                   pars = age_strat_use_pars2,
                                   events_df = com_mda) %>% 
  mutate(mean_W = (W_TC*age_strat_use_pars2["H_TC"]/H_tot2 +
                        W_UC*age_strat_use_pars2["H_UC"]/H_tot2 +
                        W_TA*age_strat_use_pars2["H_TA"]/H_tot2 + 
                        W_UA*age_strat_use_pars2["H_UA"]/H_tot2),
         I_prev = I/(S+E+I),
         Reff = mapply(Reff_Wij, W_TC, W_UC, W_TA, W_UA, MoreArgs = list(pars = age_strat_use_pars2))[2,])
  
schisto_mda_sim2 %>% 
  ggplot(aes(x = mean_W, y = Reff)) +
    geom_line() +
    theme_classic()

```

```{r narrow_par_ranges}
age_strat_eqbm <- function(alpha, Lambda_0, beta){
  
  age_strat_pars["alpha"] <- alpha
  age_strat_pars["Lambda_0"] <- Lambda_0
  age_strat_pars["beta"] <- beta
  
  eq_vals <- runsteady(y = age_start,
                       func = schisto_age_strat_mod,
                       parms = age_strat_pars,
                       stol = 1e-4) #lower tolerance to define equilibirum to speed up computation
  
  #print(c(alpha, Lambda_0, beta, eq_vals[["y"]]))
  
  return(as.data.frame(t(eq_vals$y)))
}

test_trans_pars <- expand.grid(alpha = exp(seq(log(1e-8), log(1e-2), length.out = 10)),
                               Lambda_0 = exp(seq(log(1e-8), log(1e-2), length.out = 10)),
                               beta = exp(seq(log(1e-8), log(1e-2), length.out = 10)))

age_start <- c(S=5000, E=0, I=0, W_TC=10, W_UC=10, W_TA=10, W_UA=10)

eq_vals_trans_pars <- pmap_df(test_trans_pars, age_strat_eqbm)

trans_pars_eqs <- cbind(test_trans_pars, eq_vals_trans_pars)

trans_pars_eqs %>% 
  filter(W_TC < 200 & W_TC >2) %>% 
  filter(I > 10 & I < 3000) %>% 
  View()
```




